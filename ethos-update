#!/bin/bash
# ethOS Update Script
# LICENSE AGREEMENT
#
# File Version See $VERSION Variable (c) 2016 Dale Chapman, sling00@gmail.com (“Author”).
#
# By using this file, you agree to the following:
#
# This file has been licensed to gpuShack for the exclusive use and distribution as part of ethOS. All other previous licenses
# of this file have been revoked. This license does not expire and allows for any modification, distribution, and/or derivative work
# by gpuShack and by the Author. This license extends to gpuShack’s owners, operators, officers, and contractors, where
# applicable.
#
# The Author expressly forbids and revokes usage of this file, as well as any previous iterations of this file, in any
# operating system other than ethOS. Any fork of ethOS, third party or otherwise, may not use this file without express written
# permission from the Author.
#
# Personal Use
#
# End users may modify and use this script for personal use, but may not redistribute or include in a larger work, in whole, or
# in part, without express written permission from the Author.
#
# Version History
#
# v1.x - EthOS Release
# v.1 - Development Release
#
# Portions derived from previous work by Author
#
# Red Goat License (v) 1.0
#
# This file is released under the "Small Goat with Red Eyes" license. Breaking the above license agreement will result in a
# small goat with red eyes visiting you while you sleep.
if [[ $EUID -ne 0 ]]; then
   echo "This script must be run as root, please rerun as \"sudo ethos-update\"" 
   exit 1
fi
UPDATESERVER="http://get.ethosdistro.com/ethos-updates/"
DEVELOPMENT=0 
LOG="/var/log/ethos-update.log"
CURLARGS="-f -s -S -k"
SCRIPT_NEW_VERSION="$(curl $CURLARGS http://get.ethosdistro.com/ethos-updates/version/version)"
SCRIPT_VERSION="1.02"
ETHOSVERSION=$(cat /opt/ethos/etc/version)
HOSTNAME=`cat /etc/hostname`
echo "ethOS update on $HOSTNAME starting..."
if [ $DEVELOPMENT = "0" ] ; then
  exec 1>>/var/log/ethos-update.log
  exec 2>>/var/log/ethos-update.log
fi
function f.updatescript() {
		echo "Checking if ethos-update is up to date........"
	if [ $SCRIPT_NEW_VERSION \> $SCRIPT_VERSION ]; then
		echo "Getting latest version of ethos-update"
		wget http://get.ethosdistro.com/ethos-updates/ethos-update/ethos-update.tar.gz -O /tmp/ethos-update.tar.gz
		if [ $? -eq "0" ]; then
			rm -rf /tmp/ethos-update/
			mkdir -p /tmp/ethos-update/
			tar xpf /tmp/ethos-update.tar.gz -C /tmp/ethos-update/
			if [ $? -eq "0" ]; then
#				BASE=`ls /tmp/ethos-update/`
				rm -rf /opt/ethos-update/*
				mv /tmp/ethos-update/ethos-update/* /opt/ethos-update/
				echo "Updated to latest version, relaunching."
				rm /tmp/ethos-update.tar.gz
				rm -rf /tmp/ethos-update/
				cd ~
				exec /opt/ethos-update/ethos-update
			else
				echo "Failed to extract etho-update tarball. Rerun script to try again."
			fi
		else 
			echo "Failed to download update from repo, try again in a few minutes."
			exit 0
		fi
	else 
		echo "Script up to date"
	fi
}

function f.1.0.1-1.0.2() {
	echo "Your version of ethOS is up to date. Version: $ETHOSVERSION"	
}
function f.1.0-1.0.1() {
    if [ ! -f /usr/bin/dos2unix ]; then
        apt-get -y install dos2unix
    fi
    if [ -f /usr/local/bin/helpme ]; then
        rm -f /usr/local/bin/helpme
        cp /opt/ethos-update/updates/1.0.1/opt/ethos/bin/helpme /opt/ethos/bin/helpme
    fi
 	/opt/ethos-update/updates/1.0.1/1.0.1.sh
}
function f.1.0-1.0.2() {
		/opt/ethos-update/updates/1.0.2/1.0-1.0.2.sh
}

f.updatescript

case $ETHOSVERSION in
	1.0 )
	f.1.0-1.0.2
	;;
	1.0.1 )
	if [ ! -f /usr/bin/dos2unix ]; then
		apt-get -y install dos2unix
	fi
	if [ -f /usr/local/bin/helpme ]; then
		rm -f /usr/local/bin/helpme
		cp /opt/ethos-update/updates/1.0.1/opt/ethos/bin/helpme /opt/ethos/bin/helpme
	fi
	rm -rf /opt/eth-proxy
    mkdir /opt/eth-proxy
    git clone -b 1.0.1  https://github.com/sling00/eth-proxy /opt/eth-proxy
    chown -R ethos.ethos /opt/eth-proxy
	f.1.0.1-1.0.2
	;;
esac

exec 1>/dev/tty
exec 2>/dev/tty
echo "ethOS Update on $HOSTNAME Finished, please reboot. see /var/log/ethos-update.log for details about what was updated."
