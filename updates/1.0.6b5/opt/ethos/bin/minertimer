#!/usr/bin/env bash

# Clean /var/run/timer.file on SIGINT

#trap "rm /var/log/timer.file" INT
MINERPID=`pgrep -f "/usr/local/bin/ethminer"`
task=$1
min=$2
secs=300
runs="20"
i=0
millisecondsToMinute=$(( 60000*$2 ))
notify-send -t $millisecondsToMinute -i warning "Miner Start-up Countdown" "$task" --icon=appointment-soon
#for (( i = 0; i < $runs; i++ )); do
until [ ! -z $MINERPID ]; do 
 if  [ $i -lt $secs ]; then
   i=$((i+15))
       MINERPID=`pgrep -f "/usr/local/bin/ethminer"`
	# write remaining min to file
#        timer=$((min-i))
	timer=$(echo "scale=2; ($secs - $i) / 60" | bc -l)
        if [ ! -z $MINERPID ]; then
		echo "Miner running PID: $MINERPID" > /var/run/timer.file
		notify-send -i warning "Miner Started" "PID: $MINERPID" --icon=face-smile
	       	exit 0
	else
 		display="Please Allow Up to ${timer}min before miner start"
        	echo "$display" > /var/run/timer.file
        # wait 15secs
        	sleep 15
	fi
fi
done
if [ -z $MINERPID ]; then
echo "Miner failed to start. Type "log" in terminal for more details" > /var/run/timer.file
notify-send -i warning "Miner Failed to start" "Type "log" in terminal for more details" --icon=dialog-error
fi
#rm /var/run/timer.file

